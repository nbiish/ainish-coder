name: Reusable Secret Scan

on:
  workflow_call:
    inputs:
      scan-depth:
        description: 'Depth of commit history to scan'
        required: false
        type: string
        default: '0'
      fail-on-error:
        description: 'Whether to fail the workflow if secrets are found'
        required: false
        type: boolean
        default: true

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ inputs.scan-depth }}

      - name: Determine diff range for TruffleHog
        id: diff-range
        shell: bash
        run: |
          set -e
          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
          ZERO_SHA="0000000000000000000000000000000000000000"

          if [[ -z "$DEFAULT_BRANCH" ]]; then
            DEFAULT_BRANCH="main"
          fi

          base=""
          head="${{ github.sha }}"

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            base="${{ github.event.pull_request.base.sha }}"
            head="${{ github.event.pull_request.head.sha }}"
          elif [[ -n "${{ github.event.before }}" && "${{ github.event.before }}" != "$ZERO_SHA" ]]; then
            base="${{ github.event.before }}"
          else
            git fetch origin "$DEFAULT_BRANCH" --depth=1 2>/dev/null || true
            if git rev-parse "origin/$DEFAULT_BRANCH" >/dev/null 2>&1; then
              base="origin/$DEFAULT_BRANCH"
            fi
          fi

          if [[ -z "$base" ]]; then
            base="$head"
          fi

          echo "base=$base" >> "$GITHUB_OUTPUT"
          echo "head=$head" >> "$GITHUB_OUTPUT"

          echo "Resolved diff range: $(cat "$GITHUB_OUTPUT")"

      - name: TruffleHog OSS
        continue-on-error: ${{ !inputs.fail-on-error }}
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ steps.diff-range.outputs.base }}
          head: ${{ steps.diff-range.outputs.head }}
          extra_args: --debug --only-verified

      - name: Gitleaks
        continue-on-error: ${{ !inputs.fail-on-error }}
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
