name: Pre-Commit Secret Detection

on:
  push:
    branches: [ main, dev, staging ]
  pull_request:
    branches: [ main ]

jobs:
  detect-secrets:
    uses: ./.github/workflows/reusable-secret-scan.yml
    with:
      scan-depth: '0'
      fail-on-error: false

  custom-patterns:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for specific secrets
        id: pattern-scan
        run: |
          echo "üîç Scanning for known secret patterns..."
          
          # Define patterns
          PATTERNS=(
            "BSA[a-zA-Z0-9]{27}"
            "tvly-[a-zA-Z0-9-]{30,}"
            "/Volumes/1tb-sandisk/"
            "BRAVE_API_KEY.*[\"'][^\"']{10,}[\"']"
            "tavilyApiKey=[^&\"\\s]{10,}"
          )
          
          FOUND=0
          
          for pattern in "${PATTERNS[@]}"; do
            # Grep recursively, exclude .git directory, suppress error messages
            if grep -rE --exclude-dir={.git,node_modules,venv,.venv} \
              --exclude="scan_secrets.sh" \
              --exclude="detect-secrets.yml" \
              --exclude=".git-secrets-setup.sh" \
              --exclude="sanitize-settings.sh" \
              --exclude="secret-protection-help.sh" \
              --exclude="*.md" \
              "$pattern" . 2>/dev/null | grep -vE "YOUR_[A-Z_]+_HERE|BSAtestkey|example|template|your-key-here|\$\{BRAVE_API_KEY\}"; then
              echo "‚ùå Found pattern: $pattern"
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 1 ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo ""
            echo "‚ö†Ô∏è Secrets detected. Run 'python3 .github/scripts/sanitize.py <file>' locally."
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "‚úÖ No secrets detected"
          fi

      - name: Comment on PR if secrets found
        if: steps.pattern-scan.outputs.found == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üö® **Secrets Detected in PR**\n\n' +
                    'This PR contains API keys or sensitive paths.\n\n' +
                    '**Please:**\n' +
                    '1. Run `python3 .github/scripts/sanitize.py <file>` locally\n' +
                    '2. Review and commit the changes\n' +
                    '3. Push to update this PR\n\n' +
                    '**Or use the template:**\n' +
                    '`CONFIGURATIONS/MCP/settings.json.template`'
            })
