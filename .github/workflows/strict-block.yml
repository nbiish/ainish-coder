name: Secret Detection (Report Only)

on:
  push:
    branches: [ main, dev, staging ]
  pull_request:
    branches: [ main ]

jobs:
  scanner-engines:
    name: Scanner Engines (TruffleHog/Gitleaks)
    uses: ./.github/workflows/reusable-secret-scan.yml
    with:
      scan-depth: '0'
      fail-on-error: true

  custom-patterns-blocker:
    name: Custom Patterns Blocker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for specific secrets
        run: |
          echo "üîç Scanning for known secret patterns (report-only)..."
          
          # Define patterns
          PATTERNS=(
            "BSA[a-zA-Z0-9]{27}"
            "tvly-[a-zA-Z0-9-]{30,}"
            "/Volumes/1tb-sandisk/"
            "BRAVE_API_KEY.*[\"'][^\"']{10,}[\"']"
            "tavilyApiKey=[^&\"\\s]{10,}"
          )
          
          FOUND=0
          
          for pattern in "${PATTERNS[@]}"; do
            # Grep recursively in current dir, excluding .git and this workflow file
            if grep -rE --exclude-dir=.git --exclude="strict-block.yml" "$pattern" . 2>/dev/null; then
              echo "‚ùå Found pattern: $pattern"
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 1 ]; then
            echo ""
            echo "‚ö†Ô∏è Secrets detected by custom patterns. This is report-only; workflow remains green."
            echo "Please review the logs and rotate any exposed keys if needed."
          else
            echo "‚úÖ No custom patterns detected"
          fi
